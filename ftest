#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

PYTHON_BIN="${FAKEGPU_PYTHON:-python3}"
SMOKE_BUILD_DIR="${BUILD_DIR:-build}"

usage() {
  cat <<'EOF'
Usage: ./ftest <suite>

Suites:
  smoke     Build + run basic C/Python checks (no torch required)
  cpu_sim   Build CPU simulation and validate cuBLAS ops
  python    Run PyTorch tests (requires torch)
  llm       Run LLM inference smoke test (requires torch + transformers + local model)
  all       smoke + python

Env:
  BUILD_DIR=<path>     Build directory for smoke/python (default: build)
EOF
}

suite="${1:-}"
if [[ -z "${suite}" || "${suite}" == "-h" || "${suite}" == "--help" ]]; then
  usage
  exit 0
fi

build() {
  if [[ "$(uname -s)" == "Darwin" ]]; then
    cmake -S . -B "$SMOKE_BUILD_DIR" -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
  else
    cmake -S . -B "$SMOKE_BUILD_DIR"
  fi
  cmake --build "$SMOKE_BUILD_DIR"
}

build_cpu_sim() {
  if [[ "$(uname -s)" == "Darwin" ]]; then
    cmake -S . -B build_cpu_sim -DENABLE_FAKEGPU_CPU_SIMULATION=ON -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
  else
    cmake -S . -B build_cpu_sim -DENABLE_FAKEGPU_CPU_SIMULATION=ON
  fi
  cmake --build build_cpu_sim
}

compile_verify_preload() {
  local out="$SMOKE_BUILD_DIR/verify_preload"
  if [[ "$(uname -s)" == "Darwin" ]]; then
    cc verification/verify_preload.c -o "$out"
  else
    cc verification/verify_preload.c -o "$out" -ldl
  fi
}

run_cpu_sim() {
  build_cpu_sim
  local out="build_cpu_sim/test_cublas_cpu_sim"
  c++ -std=c++17 verification/test_cublas_cpu_sim.cpp -o "$out" \
    -L build_cpu_sim -lcublas -lcudart -lcuda -lnvidia-ml
  FAKEGPU_REPORT_PATH="build_cpu_sim/fake_gpu_report.json" ./fgpu --build-dir build_cpu_sim "$out"
  "$PYTHON_BIN" verification/check_report.py --path build_cpu_sim/fake_gpu_report.json --expect-io --expect-flops

  if "$PYTHON_BIN" -c "import torch" >/dev/null 2>&1; then
    FAKEGPU_REPORT_PATH="build_cpu_sim/fake_gpu_report.json" ./fgpu --build-dir build_cpu_sim "$PYTHON_BIN" verification/test_cpu_sim_matmul.py
  else
    echo "torch not found in current python; skipping PyTorch matmul correctness check."
  fi
}

run_smoke() {
  build
  compile_verify_preload
  FAKEGPU_REPORT_PATH="$SMOKE_BUILD_DIR/fake_gpu_report.json" ./fgpu --build-dir "$SMOKE_BUILD_DIR" "$SMOKE_BUILD_DIR/verify_preload"
  "$PYTHON_BIN" verification/check_report.py --path "$SMOKE_BUILD_DIR/fake_gpu_report.json"
  FAKEGPU_REPORT_PATH="$SMOKE_BUILD_DIR/fake_gpu_report_multi_arch.json" ./fgpu --build-dir "$SMOKE_BUILD_DIR" --devices "a100,h100,b100,b200" "$PYTHON_BIN" verification/test_multi_arch_compute_units.py
  FAKEGPU_REPORT_PATH="$SMOKE_BUILD_DIR/fake_gpu_report_memory_types.json" ./fgpu --build-dir "$SMOKE_BUILD_DIR" "$PYTHON_BIN" verification/test_memory_types.py
}

run_python() {
  if ! "$PYTHON_BIN" -c "import torch" >/dev/null 2>&1; then
    echo "torch not found in current python; skipping PyTorch tests."
    return 0
  fi
  build
  FAKEGPU_REPORT_PATH="$SMOKE_BUILD_DIR/fake_gpu_report.json" ./fgpu --build-dir "$SMOKE_BUILD_DIR" "$PYTHON_BIN" test/test_pytorch_basic.py
  "$PYTHON_BIN" verification/check_report.py --path "$SMOKE_BUILD_DIR/fake_gpu_report.json"
}

run_llm() {
  if ! "$PYTHON_BIN" -c "import torch, transformers" >/dev/null 2>&1; then
    echo "torch/transformers not found in current python; skipping LLM smoke test."
    return 0
  fi

  local model_dir="$HOME/models/Qwen/Qwen2.5-0.5B-Instruct"
  if [[ ! -d "$model_dir" ]]; then
    echo "LLM model files not found at $model_dir; skipping LLM smoke test."
    return 0
  fi

  build
  local -a timeout_cmd=()
  if command -v timeout >/dev/null 2>&1; then
    timeout_cmd=(timeout 300)
  fi

  FAKEGPU_REPORT_PATH="$SMOKE_BUILD_DIR/fake_gpu_report_llm.json" \
    "${timeout_cmd[@]}" ./fgpu --build-dir "$SMOKE_BUILD_DIR" "$PYTHON_BIN" test/test_load_qwen2_5.py
  "$PYTHON_BIN" verification/check_report.py --path "$SMOKE_BUILD_DIR/fake_gpu_report_llm.json"
}

case "$suite" in
  smoke)
    run_smoke
    ;;
  cpu_sim)
    run_cpu_sim
    ;;
  python)
    run_python
    ;;
  llm)
    run_llm
    ;;
  all)
    run_smoke
    run_python
    ;;
  *)
    usage
    exit 2
    ;;
esac
