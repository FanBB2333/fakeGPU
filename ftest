#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

PYTHON_BIN="${FAKEGPU_PYTHON:-python3}"

usage() {
  cat <<'EOF'
Usage: ./ftest <suite>

Suites:
  smoke     Build + run basic C/Python checks (no torch required)
  cpu_sim   Build CPU simulation and validate cuBLAS ops
  python    Run PyTorch tests (requires torch)
  all       smoke + python
EOF
}

suite="${1:-}"
if [[ -z "${suite}" || "${suite}" == "-h" || "${suite}" == "--help" ]]; then
  usage
  exit 0
fi

build() {
  cmake -S . -B build
  cmake --build build
}

build_cpu_sim() {
  cmake -S . -B build_cpu_sim -DENABLE_FAKEGPU_CPU_SIMULATION=ON
  cmake --build build_cpu_sim
}

compile_verify_preload() {
  local out="build/verify_preload"
  if [[ "$(uname -s)" == "Darwin" ]]; then
    cc verification/verify_preload.c -o "$out"
  else
    cc verification/verify_preload.c -o "$out" -ldl
  fi
}

run_cpu_sim() {
  build_cpu_sim
  local out="build_cpu_sim/test_cublas_cpu_sim"
  c++ -std=c++17 verification/test_cublas_cpu_sim.cpp -o "$out" \
    -L build_cpu_sim -lcublas -lcudart -lcuda -lnvidia-ml
  ./fgpu --build-dir build_cpu_sim "$out"
}

run_smoke() {
  build
  compile_verify_preload
  ./fgpu build/verify_preload
}

run_python() {
  if ! "$PYTHON_BIN" -c "import torch" >/dev/null 2>&1; then
    echo "torch not found in current python; skipping PyTorch tests."
    return 0
  fi
  build
  ./fgpu "$PYTHON_BIN" test/test_pytorch_basic.py
}

case "$suite" in
  smoke)
    run_smoke
    ;;
  cpu_sim)
    run_cpu_sim
    ;;
  python)
    run_python
    ;;
  all)
    run_smoke
    run_python
    ;;
  *)
    usage
    exit 2
    ;;
esac
