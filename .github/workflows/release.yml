name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify tag matches version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          python - <<'PY'
          import os
          import pathlib
          import re

          tag = os.environ["GITHUB_REF_NAME"]
          text = pathlib.Path("fakegpu/_version.py").read_text(encoding="utf-8")
          match = re.search(r'__version__\s*=\s*"([^"]+)"\s*$', text, re.M)
          if not match:
              raise SystemExit("Could not parse __version__ from fakegpu/_version.py")
          version = match.group(1)
          expected = f"v{version}"
          if tag != expected:
              raise SystemExit(f"Tag {tag!r} does not match expected {expected!r}")
          PY

      - name: Build sdist
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --sdist

      - name: Build wheel (manylinux x86_64)
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: dist
        env:
          CIBW_BUILD: "cp311-manylinux_x86_64"
          CIBW_BUILD_VERBOSITY: "1"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
